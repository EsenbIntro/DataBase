library=# CREATE DATABASE advanced_queries;
CREATE DATABASE
library=# \c advanced_queries
You are now connected to database "advanced_queries" as user "postgres".

advanced_queries=# CREATE TABLE employees (
advanced_queries(#     employee_id SERIAL PRIMARY KEY,
advanced_queries(#     first_name VARCHAR(50),
advanced_queries(#     last_name VARCHAR(50),
advanced_queries(#     department VARCHAR(50),
advanced_queries(#     salary INT,
advanced_queries(#     manager_id INT,
advanced_queries(#     tenure INT
advanced_queries(# );
CREATE TABLE

advanced_queries=# INSERT INTO employees (employee_id, first_name, last_name, department, salary, manager_id, tenure) VALUES
advanced_queries-# (1, 'James', 'Smith', 'CEO', 250000, NULL, 12),
advanced_queries-# (2, 'Maria', 'Garcia', 'Engineering', 150000, 1, 8),
advanced_queries-# (3, 'David', 'Wilson', 'Engineering', 135000, 2, 6),
advanced_queries-# (4, 'Linda', 'Martinez', 'Engineering', 142000, 2, 7),
advanced_queries-# (5, 'Robert', 'Lee', 'Sales', 110000, 1, 9),
advanced_queries-# (6, 'Jennifer', 'Walker', 'Sales', 95000, 5, 4),
advanced_queries-# (7, 'Michael', 'Hall', 'Sales', 105000, 5, 5);
INSERT 0 7

advanced_queries=# CREATE TABLE orders (
advanced_queries(#     order_id SERIAL PRIMARY KEY,
advanced_queries(#     region_id INT,
advanced_queries(#     amount INT,
advanced_queries(#     status VARCHAR(50)
advanced_queries(# );
CREATE TABLE

advanced_queries=# INSERT INTO orders (region_id, amount, status) VALUES
advanced_queries-# (1, 500000, 'Medium Priority'),
advanced_queries-# (2, 1200000, 'High Priority'),
advanced_queries-# (1, 600000, 'Low Priority'),
advanced_queries-# (3, 800000, 'Medium Priority'),
advanced_queries-# (2, 300000, 'High Priority');
INSERT 0 5

advanced_queries=# CREATE TABLE warehouse_1 (
advanced_queries(#     product_id SERIAL PRIMARY KEY,
advanced_queries(#     product_name VARCHAR(50),
advanced_queries(#     quantity INT
advanced_queries(# );
CREATE TABLE

advanced_queries=# CREATE TABLE warehouse_2 (
advanced_queries(#     product_id SERIAL PRIMARY KEY,
advanced_queries(#     product_name VARCHAR(50),
advanced_queries(#     quantity INT
advanced_queries(# );
CREATE TABLE

advanced_queries=# INSERT INTO warehouse_1 (product_name, quantity) VALUES ('Laptop', 10), ('Mouse', 0), ('Keyboard', 5);
INSERT 0 3

advanced_queries=# INSERT INTO warehouse_2 (product_name, quantity) VALUES ('Monitor', 8), ('Mouse', 0), ('Laptop', 3);
INSERT 0 3
advanced_queries=# CREATE TABLE sales (
advanced_queries(#     product_name VARCHAR(50),
advanced_queries(#     year INT,
advanced_queries(#     sales_amount INT
advanced_queries(# );
CREATE TABLE

advanced_queries=# INSERT INTO sales (product_name, year, sales_amount) VALUES
advanced_queries-# ('Laptop', 2022, 50000),
advanced_queries-# ('Laptop', 2023, 55000),
advanced_queries-# ('Laptop', 2024, 62000),
advanced_queries-# ('Mouse', 2022, 8000),
advanced_queries-# ('Mouse', 2023, 9500),
advanced_queries-# ('Mouse', 2024, 9800);
INSERT 0 6

advanced_queries=# SELECT first_name, last_name, salary
advanced_queries-# FROM employees
advanced_queries-# WHERE salary > (SELECT AVG(salary) FROM employees);
 first_name | last_name | salary
------------+-----------+--------
 James      | Smith     | 250000
 Maria      | Garcia    | 150000
 David      | Wilson    | 135000
 Linda      | Martinez  | 142000
(4 rows)

advanced_queries=# WITH regional_sales AS (
advanced_queries(#   SELECT region_id, SUM(amount) AS total_sales
advanced_queries(#   FROM orders
advanced_queries(#   GROUP BY region_id
advanced_queries(# )
advanced_queries-# SELECT region_id, total_sales
advanced_queries-# FROM regional_sales
advanced_queries-# WHERE total_sales > 1000000;
 region_id | total_sales
-----------+-------------
         1 |     1100000
         2 |     1500000
(2 rows)

advanced_queries=# WITH RECURSIVE org_chart AS (
advanced_queries(#   SELECT employee_id, first_name, last_name, manager_id, 1 as level
advanced_queries-#   FROM employees
advanced_queries-#   WHERE manager_id IS NULL
advanced_queries-# UNION ALL
advanced_queries(#   SELECT e.employee_id, e.first_name, e.last_name, e.manager_id, oc.level + 1
advanced_queries-#   FROM employees e
advanced_queries-#   INNER JOIN org_chart oc ON e.manager_id = oc.employee_id
advanced_queries(# )
advanced_queries-# SELECT * FROM org_chart;
 employee_id | first_name | last_name | manager_id | level
-------------+------------+-----------+------------+-------
           1 | James      | Smith     |            |     1
           2 | Maria      | Garcia    |          1 |     2
           5 | Robert     | Lee       |          1 |     2
           3 | David      | Wilson    |          2 |     3
           4 | Linda      | Martinez  |          2 |     3
           6 | Jennifer   | Walker    |          5 |     3
           7 | Michael    | Hall      |          5 |     3
(7 rows)

advanced_queries=# SELECT product_name FROM warehouse_1
advanced_queries-# UNION
advanced_queries-# SELECT product_name FROM warehouse_2;
 product_name
--------------
 Laptop
 Monitor
 Mouse
 Keyboard
(4 rows)

advanced_queries=# SELECT product_name FROM warehouse_1
advanced_queries-# UNION ALL
advanced_queries-# SELECT product_name FROM warehouse_2;
 product_name
--------------
 Laptop
 Mouse
 Keyboard
 Monitor
 Mouse
 Laptop
(6 rows)

advanced_queries=# SELECT product_id FROM warehouse_1 WHERE quantity = 0
advanced_queries-# INTERSECT
advanced_queries-# SELECT product_id FROM warehouse_2 WHERE quantity = 0;
 product_id
------------
          2
(1 row)

advanced_queries=# SELECT product_name FROM warehouse_1
advanced_queries-# EXCEPT
advanced_queries-# SELECT product_name FROM warehouse_2;
 product_name
--------------
 Keyboard
(1 row)

advanced_queries=# SELECT
advanced_queries-#  first_name,
advanced_queries-#  last_name,
advanced_queries-#  department,
advanced_queries-#  salary,
advanced_queries-#  RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS dept_salary_rank
advanced_queries-# FROM employees;
 first_name | last_name | department  | salary | dept_salary_rank
------------+-----------+-------------+--------+------------------
 James      | Smith     | CEO         | 250000 |                1
 Maria      | Garcia    | Engineering | 150000 |                1
 Linda      | Martinez  | Engineering | 142000 |                2
 David      | Wilson    | Engineering | 135000 |                3
 Robert     | Lee       | Sales       | 110000 |                1
 Michael    | Hall      | Sales       | 105000 |                2
 Jennifer   | Walker    | Sales       |  95000 |                3
(7 rows)

advanced_queries=# SELECT
advanced_queries-#  product_name,
advanced_queries-#  SUM(CASE WHEN year = 2022 THEN sales_amount ELSE 0 END) AS year_2022,
advanced_queries-#  SUM(CASE WHEN year = 2023 THEN sales_amount ELSE 0 END) AS year_2023,
advanced_queries-#  SUM(CASE WHEN year = 2024 THEN sales_amount ELSE 0 END) AS year_2024
advanced_queries-# FROM sales
advanced_queries-# GROUP BY product_name;
 product_name | year_2022 | year_2023 | year_2024
--------------+-----------+-----------+-----------
 Mouse        |      8000 |      9500 |      9800
 Laptop       |     50000 |     55000 |     62000
(2 rows)

advanced_queries=# WITH pivoted_sales AS (
advanced_queries(#   SELECT
advanced_queries(#     product_name,
advanced_queries(#     SUM(CASE WHEN year = 2022 THEN sales_amount ELSE 0 END) AS year_2022,
advanced_queries(#     SUM(CASE WHEN year = 2023 THEN sales_amount ELSE 0 END) AS year_2023,
advanced_queries(#     SUM(CASE WHEN year = 2024 THEN sales_amount ELSE 0 END) AS year_2024
advanced_queries(#   FROM sales
advanced_queries(#   GROUP BY product_name
advanced_queries(# )
advanced_queries-# SELECT product_name, '2022' AS year, year_2022 AS sales_amount FROM pivoted_sales
advanced_queries-# UNION ALL
advanced_queries-# SELECT product_name, '2023' AS year, year_2023 AS sales_amount FROM pivoted_sales
advanced_queries-# UNION ALL
advanced_queries-# SELECT product_name, '2024' AS year, year_2024 AS sales_amount FROM pivoted_sales
advanced_queries-# ORDER BY product_name, year;
 product_name | year | sales_amount
--------------+------+--------------
 Laptop       | 2022 |        50000
 Laptop       | 2023 |        55000
 Laptop       | 2024 |        62000
 Mouse        | 2022 |         8000
 Mouse        | 2023 |         9500
 Mouse        | 2024 |         9800
(6 rows)

advanced_queries=# SELECT
advanced_queries-#  employee_id,
advanced_queries-#  SUM(salary) OVER (PARTITION BY department) AS total_dept_salary,
advanced_queries-#  AVG(salary) FILTER (WHERE tenure > 5) OVER (PARTITION BY department) AS avg_salary_senior
advanced_queries-# FROM employees;
 employee_id | total_dept_salary |  avg_salary_senior
-------------+-------------------+----------------------
           1 |            250000 | 250000.000000000000
           2 |            427000 | 142333.333333333333
           3 |            427000 | 142333.333333333333
           4 |            427000 | 142333.333333333333
           5 |            310000 | 110000.000000000000
           7 |            310000 | 110000.000000000000
           6 |            310000 | 110000.000000000000
(7 rows)

advanced_queries=# SELECT order_id, status FROM orders ORDER BY
advanced_queries-# CASE status
advanced_queries-#   WHEN 'High Priority' THEN 1
advanced_queries-#   WHEN 'Medium Priority' THEN 2
advanced_queries-#   WHEN 'Low Priority' THEN 3
advanced_queries-#   ELSE 4
advanced_queries-# END;
 order_id |      status
----------+-----------------
        2 | High Priority
        5 | High Priority
        1 | Medium Priority
        4 | Medium Priority
        3 | Low Priority
(5 rows)